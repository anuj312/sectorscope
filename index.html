<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sector Flow Scanner</title>

<style>
    /* =========================================================
   DESIGN TOKENS / THEME
   ========================================================= */
:root{
  --bg:#020617;
  --panel:#0b1220;
  --panel2:#0f172a;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;

  --green:#22c55e;
  --red:#ef4444;
  --cyan:#38bdf8;
  --purple:#a78bfa;
  --orange:#fb923c;
}

/* =========================================================
   BASE RESET
   ========================================================= */
*{ box-sizing:border-box; }

body{
  margin:0;
  padding:22px;
  background:radial-gradient(1200px 600px at 20% -10%, #0b1220, #020617);
  color:var(--text);
  font-family:Inter,system-ui;
}

/* =========================================================
   LOADER
   ========================================================= */
#loader{
  position:fixed;
  inset:0;
  background:#020617;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.loader-box{ width:360px; text-align:center; }

.loader-box h2{
  margin:0 0 12px;
  color:var(--cyan);
  font-size:20px;
}

.progress-track{
  height:10px;
  background:#1e293b;
  border-radius:8px;
  overflow:hidden;
}

.progress-bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#38bdf8,#a78bfa);
  transition:width .3s ease;
}

.loader-meta{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
}

/* =========================================================
   HEADER
   ========================================================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:14px;
}

h1{ margin:0; font-size:22px; }
.meta{ font-size:13px; color:var(--muted); }

/* =========================================================
   GRID LAYOUTS
   ========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
  gap:18px;
}

/* =========================================================
   PREMIUM INSTITUTIONAL THEME
   ========================================================= */

:root{
  --bg:#020617;
  --panel:#0b1220;
  --panel-soft:#0f172a;
  --border:#1e293b;

  --text:#e5e7eb;
  --muted:#94a3b8;

  --green:#22c55e;
  --red:#ef4444;
  --cyan:#38bdf8;
  --purple:#a78bfa;
}

/* =========================================================
   BASE RESET
   ========================================================= */
*{ box-sizing:border-box; }

body{
  margin:0;
  padding:22px;
  background:
    radial-gradient(1000px 500px at 15% -10%, #0b1220, #020617 65%);
  color:var(--text);
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont;
  letter-spacing:.15px;
}

/* =========================================================
   HEADER
   ========================================================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:18px;
}

h1{
  margin:0;
  font-size:22px;
  font-weight:800;
  letter-spacing:.4px;
}

.meta{
  font-size:12.5px;
  color:var(--muted);
}

/* =========================================================
   GRID
   ========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
  gap:20px;
}

#vwapLeaders{
  grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
}

/* =========================================================
   STANDARD CARDS (SECTORS)
   ========================================================= */
.card{
  background:
    linear-gradient(180deg,#0b1220,#070c1a);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  box-shadow:
    0 18px 40px rgba(0,0,0,.55),
    inset 0 1px 0 rgba(255,255,255,.04);
  transition:transform .25s ease, box-shadow .25s ease;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:
    0 25px 60px rgba(0,0,0,.7);
}

/* =========================================================
   SIGNAL CARDS (TERMINAL GRADE)
   ========================================================= */
.signal-card{
  position:relative;
  border-radius:20px;
  padding:18px;

  background:
    linear-gradient(180deg,#060b18,#020617);

  border:1px solid rgba(255,255,255,.08);

  box-shadow:
    0 35px 90px rgba(0,0,0,.85),
    inset 0 1px 1px rgba(255,255,255,.05);

  overflow:hidden;
}

/* subtle signal glow (not flashy) */
.signal-card::before{
  content:"";
  position:absolute;
  inset:-1px;
  border-radius:20px;
  background:linear-gradient(120deg,transparent,currentColor,transparent);
  opacity:.18;
  filter:blur(16px);
  z-index:-1;
}

/* =========================================================
   SIGNAL TITLES
   ========================================================= */
.signal-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  font-weight:800;
  letter-spacing:2.5px;
  text-transform:uppercase;
  padding-bottom:10px;
  margin-bottom:12px;
  border-bottom:1px solid rgba(255,255,255,.12);
}

/* Signal identity */
.signal-vwap   { color:var(--cyan); }
.signal-volume { color:var(--green); }
.signal-sector { color:var(--purple); }

/* =========================================================
   TABLES (TERMINAL STYLE)
   ========================================================= */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12.5px;
}

thead th{
  font-size:11px;
  color:var(--muted);
  font-weight:700;
  letter-spacing:1px;
  text-transform:uppercase;
  text-align:right;
  padding:8px 6px;
  border-bottom:1px solid var(--border);
}

thead th:first-child,
tbody td:first-child{ text-align:left; }

tbody td{
  padding:7px 6px;
  border-bottom:1px solid rgba(255,255,255,.06);
  text-align:right;
}

tbody tr:hover{
  background:rgba(255,255,255,.04);
}

/* =========================================================
   SCROLL CONTAINERS
   ========================================================= */
.signal-scroll,
.table-scroll{
  max-height:280px;
  overflow-y:auto;
  border-radius:12px;
}

/* professional scrollbar */
.signal-scroll::-webkit-scrollbar,
.table-scroll::-webkit-scrollbar{
  width:5px;
}

.signal-scroll::-webkit-scrollbar-thumb,
.table-scroll::-webkit-scrollbar-thumb{
  background:#334155;
  border-radius:6px;
}

/* =========================================================
   SECTOR HEADER BADGE
   ========================================================= */
.sector-name{
  display:inline-block;
  margin-bottom:8px;
  padding:6px 14px;
  font-size:12px;
  font-weight:800;
  letter-spacing:1.4px;
  text-transform:uppercase;
  border-radius:999px;
  color:#e0f2fe;
  background:
    linear-gradient(#020617,#020617) padding-box,
    linear-gradient(90deg,#38bdf8,#22c55e,#a78bfa) border-box;
  border:1.5px solid transparent;
}

/* =========================================================
   KPI BLOCKS
   ========================================================= */
.kpis{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-top:10px;
}

.kpi{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:10px 12px;
}

.kpi label{
  font-size:10px;
  color:var(--muted);
  letter-spacing:1px;
  text-transform:uppercase;
  font-weight:700;
}

.kpi span{
  display:block;
  margin-top:2px;
  font-size:14px;
  font-weight:900;
}

/* KPI COLORS */
.green{ color:var(--green); }
.red{ color:var(--red); }
.gray{ color:var(--muted); }
.purple{ color:var(--purple); }

/* =========================================================
   STOCK LINKS
   ========================================================= */
/* =========================================================
   STOCK LINKS ‚Äî WHITE, PROFESSIONAL
   ========================================================= */
.stock-link{
  cursor:pointer;
  color: #e5e7eb;            /* pure terminal white */
  font-weight: 700;
  transition: color .15s ease, opacity .15s ease;
}

.stock-link:hover{
  color: var(--cyan);        /* subtle signal on intent */
  opacity: 0.95;
  text-decoration: none;    /* cleaner than underline */
}

    /* =========================================================
   VWAP VALUE COLORS ‚Äî GUARANTEED
   ========================================================= */
.vwap-pos{
  color: #22c55e !important; /* GREEN */
  font-weight: 900;
}

.vwap-neg{
  color: #ef4444 !important; /* RED */
  font-weight: 900;
}


    /* =========================================================
   TOP LIVE VOLUME SECTORS ‚Äî BOLD SECTOR NAMES
   ========================================================= */
.signal-sector tbody td:first-child{
  font-weight: 900;
  color:color: var(--purple);
  letter-spacing: 0.2px;
}

    /* =========================================================
   SECTOR TABLE ‚Äî BOLD KEY METRIC VALUES
   ========================================================= */

/* 20D (column 2) */
.card tbody td:nth-child(2){
  font-weight: 800;
}

/* Live (column 3) */
.card tbody td:nth-child(3){
  font-weight: 900;
}

/* VWAP (column 4) */
.card tbody td:nth-child(4){
  font-weight: 900;
}




</style>
</head>

<body>

<div id="loader">
    <div class="loader-box">
        <h2>Starting Scanner</h2>
        <div class="progress-track">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="loader-meta">
            <span id="progressPct">0%</span> ¬∑
            <span id="progressMsg">Initializing‚Ä¶</span>
        </div>
    </div>
</div>

<div class="header">
    <h1>üõ∞Ô∏è Sector Flow Scanner</h1>
    <div class="meta" id="meta">--</div>
</div>

<div class="grid" id="vwapLeaders"></div>
<div class="grid" id="grid"></div>

            <script>
    /* =========================================================
       STATE
       ========================================================= */
    let currentMode = "EOD";
    let totalTicks = 0;
    let tps = 0;


    /* =========================================================
       DOM REFERENCES
       ========================================================= */
    const loader = document.getElementById("loader");
    const progressBar = document.getElementById("progressBar");
    const progressPct = document.getElementById("progressPct");
    const progressMsg = document.getElementById("progressMsg");
    const meta = document.getElementById("meta");
    const vwapLeaders = document.getElementById("vwapLeaders");
    const grid = document.getElementById("grid");


    /* =========================================================
       UTILITIES / HELPERS
       ========================================================= */
    function formatINR(n){
      n = Number(n || 0);
      if(n >= 1e7) return (n / 1e7).toFixed(1) + " Cr";
      if(n >= 1e5) return (n / 1e5).toFixed(1) + " L";
      return n.toLocaleString("en-IN");
    }

    function openChart(symbol){
      const tvSymbol = `NSE:${encodeURIComponent(symbol)}`;
      window.open(
        `https://www.tradingview.com/chart/?symbol=${tvSymbol}`,
        "_blank"
      );
    }


    /* =========================================================
       LOADER / STATUS
       ========================================================= */
    async function pollStatus(){
      try{
        const r = await fetch("/status", { cache:"no-store" });
        const j = await r.json();

        progressBar.style.width = j.progress + "%";
        progressPct.innerText = j.progress + "%";
        progressMsg.innerText = j.message;

        if(j.progress >= 100){
          loader.style.display = "none";
          clearInterval(loaderTimer);
        }
      }catch(e){}
    }

    const loaderTimer = setInterval(pollStatus, 600);
    pollStatus();


    /* =========================================================
       METRICS (TICKS / TPS)
       ========================================================= */
    async function pollMetrics(){
      try{
        const r = await fetch("/metrics", { cache:"no-store" });
        const j = await r.json();

        totalTicks = j.total_ticks || 0;
        tps = j.ticks_per_sec || 0;
      }catch(e){}
    }

    setInterval(pollMetrics, 1000);
    pollMetrics();


    /* =========================================================
       MARKET TIME / HEADER
       ========================================================= */
    function marketCountdown(){
      const istNow = new Date(
        new Date().toLocaleString("en-US", { timeZone:"Asia/Kolkata" })
      );

      const open = new Date(istNow);
      open.setHours(9,15,0,0);
      if(istNow > open) open.setDate(open.getDate() + 1);

      const diff = Math.floor((open - istNow) / 1000);
      if(diff <= 0) return "";

      const h = String(Math.floor(diff / 3600)).padStart(2,"0");
      const m = String(Math.floor((diff % 3600) / 60)).padStart(2,"0");
      const s = String(diff % 60).padStart(2,"0");

      return `‚è≥ Market opens in <b>${h}:${m}:${s}</b>`;
    }

    function updateHeader(){
      const t = new Date().toLocaleTimeString("en-IN", { hour12:false });
      let extra = "";

      if(currentMode === "LIVE"){
        extra =
          ` | üìä <b>${totalTicks.toLocaleString("en-IN")}</b> ticks` +
          ` | ‚ö° <b>${tps}</b> TPS`;
      }else{
        const cd = marketCountdown();
        if(cd) extra = " | " + cd;
      }

      meta.innerHTML =
        `üïí <b>${t}</b> | <b>${currentMode}</b> MODE${extra}`;
    }

    setInterval(updateHeader, 1000);


    /* =========================================================
       TOP CARDS ‚Äì VWAP / STOCK VOLUME / SECTOR VOLUME
       ========================================================= */
    function renderVWAPLeaders(data){
      const stockMap = new Map();

Object.values(data).forEach(sec => {
  sec.stocks.forEach(s => {
    if (!stockMap.has(s.symbol)) {
      stockMap.set(s.symbol, s);
    }
  });
});

const allStocks = Array.from(stockMap.values());


    const sortedVWAP = [...allStocks].sort((a,b)=>b.vwap_dev-a.vwap_dev);

const topVWAP = sortedVWAP.slice(0,20);
const bottomVWAP = [...sortedVWAP].reverse().slice(0,20);


      const vwapCard = `
  <div class="card signal-card signal-vwap">
    <div class="signal-title">
      <span>üìä</span> TOP / BOTTOM 10 VWAP
    </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            ${renderStockTable("üîº TOP 10", topVWAP, "vwap")}
            ${renderStockTable("üîΩ BOTTOM 10", bottomVWAP, "vwap")}
          </div>
        </div>
      `;

      vwapLeaders.innerHTML =
        vwapCard +
        renderVolumeLeaders(data) +
        renderSectorVolumeLeaders(data);
    }

    function renderVolumeLeaders(data){
     const stockMap = new Map();

Object.values(data).forEach(sec => {
  sec.stocks.forEach(s => {
    if (!stockMap.has(s.symbol)) {
      stockMap.set(s.symbol, s);
    }
  });
});

const allStocks = Array.from(stockMap.values());


      const sortedVol = [...allStocks].sort((a,b)=>b.live_vol-a.live_vol);

const topVol = sortedVol.slice(0,20);
const bottomVol = [...sortedVol].reverse().slice(0,20);


      return `
  <div class="card signal-card signal-volume">
    <div class="signal-title">
      <span>üîä</span> TOP / BOTTOM 10 LIVE VOLUME
    </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            ${renderStockTable("üîº TOP 10", topVol, "vol")}
            ${renderStockTable("üîΩ BOTTOM 10", bottomVol, "vol")}
          </div>
        </div>
      `;
    }

    function renderSectorVolumeLeaders(data){
      const sectors = Object.entries(data)
        .map(([name,o]) => ({ name, live:o.sector_live }))
        .sort((a,b)=>b.live-a.live)
        .slice(0,10);

        return `
  <div class="card signal-card signal-sector">
    <div class="signal-title">
      <span>üß≠</span> TOP LIVE VOLUME SECTORS
    </div>

          <table>
            <thead><tr><th>Sector</th><th>Live Vol</th></tr></thead>
            <tbody>
              ${sectors.map(s=>`
                <tr>
                  <td>${s.name}</td>
                  <td class="green">${formatINR(s.live)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderStockTable(title, list, type){
  return `
    <div>
      <div style="font-weight:700;margin-bottom:6px">
        ${title}
      </div>

      <!-- üëá SCROLL START -->
      <div class="signal-scroll">
        <table>
          <thead>
            <tr>
              <th>Stock</th>
              <th>${type === "vwap" ? "VWAP" : "Live Vol"}</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(s=>`
              <tr>
                <td>
                  <span class="stock-link" data-symbol="${s.symbol}">
                    ${s.symbol}
                  </span>
                </td>
                <td class="${
                  type === "vwap"
                    ? (s.vwap_dev > 0 ? "vwap-pos" : "vwap-neg")
                    : (s.live_vol > 0 ? "green" : "gray")
                }">
                  ${
                    type === "vwap"
                      ? `${s.vwap_dev}%`
                      : formatINR(s.live_vol)
                  }
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
      <!-- üëÜ SCROLL END -->

    </div>
  `;
}


    /* =========================================================
       SECTOR GRID
       ========================================================= */
    function renderGrid(data){
      grid.innerHTML = "";

      Object.entries(data)
        .sort((a,b)=>b[1].fss-a[1].fss)
        .forEach(([sector,o])=>{
          const rows = o.stocks
            .sort((a,b)=>b.vwap_dev-a.vwap_dev)
            .map(st=>`
              <tr>
                <td>
                  <span class="stock-link" data-symbol="${st.symbol}">
                    ${st.symbol}
                  </span>
                </td>
                <td>${formatINR(st.avg_20d_vol)}</td>
                <td>${formatINR(st.live_vol)}</td>
                <td class="${st.vwap_dev>0?'green':st.vwap_dev<0?'red':'gray'}">
                  ${st.vwap_dev}%
                </td>
              </tr>
            `).join("");

          grid.innerHTML += `
            <div class="card">
              <div class="sector-name">${sector}</div>
              <div class="kpis">
               <div class="kpi live">
  <label>LIVE</label>
  <span class="purple">${formatINR(o.sector_live)}</span>
</div>

<div class="kpi avg">
  <label>20D</label>
  <span>${formatINR(o.sector_avg)}</span>
</div>

<div class="kpi vwap">
  <label>VWAP</label>
  <span class="${
    o.sector_vwap > 0 ? 'green' :
    o.sector_vwap < 0 ? 'red' : 'gray'
  }">
    ${o.sector_vwap}%
  </span>
</div>

<div class="kpi fss">
  <label>FSS</label>
  <span class="${
    o.fss > 0 ? 'green' :
    o.fss < 0 ? 'red' : 'gray'
  }">
    ${o.fss}
  </span>
</div>

              </div>
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr><th>Stock</th><th>20D</th><th>Live</th><th>VWAP</th></tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          `;
        });
    }


    /* =========================================================
       REFRESH LOOP (MINUTE-ALIGNED)
       ========================================================= */
    async function refresh(){
      try{
        const r = await fetch("/live", { cache:"no-store" });
        const j = await r.json();
        currentMode = j.mode;

        renderVWAPLeaders(j.data);
        renderGrid(j.data);
      }catch(e){}
    }

    function startMinuteAlignedRefresh(){
      refresh();
      const now = new Date();
      const delay =
        (60 - now.getSeconds()) * 1000 - now.getMilliseconds();

      setTimeout(()=>{
        refresh();
        setInterval(refresh, 60000);
      }, delay);
    }

    startMinuteAlignedRefresh();


    /* =========================================================
       GLOBAL EVENTS
       ========================================================= */
    document.addEventListener("click", e => {
      const el = e.target.closest(".stock-link");
      if(!el) return;
      openChart(el.dataset.symbol);
    });
</script>



</body>
</html>
